# MS2 preprocessing targeted
Please copy the template of excel file (**J:\\CBMR\\SUN-CBMR-Metabolomics\\Workflow\\utils\\utils_MS2_preprocessing\\LCMS_library_template.xlsx**) and fill in the information related to the standards which you would like to preprocess. You must fill the columns in <font color = "red">red color</font>




## XCMS_check retention time
Check if the retention time of each standard from MS2 is similar to that from MS1

The script `2b.Pipeline_XCMS_checkRT.R` is available under the folder of `J:\CBMR\SUN-CBMR-Metabolomics\Workflow\Script\modules\MS2_preprocessing`



### Source paths on the server
```{r eval=FALSE}
source("H:/From_SUND/Scripts/utils/utils_MS2_set_up/set_up_paths.R")
```


### Provide polarity ðŸ•µ
```{r eval=FALSE}
polarity <- "POS"
```

   
   
### Path of storing .mzML files without filenames ðŸ•µ
```{r eval=FALSE}
path_files_mzML <- "H:/From_SUND/Scripts/test/MS2pos_target/mzML_openms_MS2_POS"
```
   
  

### Path of storing outputs ðŸ•µ
```{r eval=FALSE}
path_outputs <- "H:/From_SUND/Scripts/outputs"
```



### Filename for containing information of standards including absolute path (Please fill in the provided template) ðŸ•µ
```{r eval=FALSE}
xlsx_std_info <- "H:/From_SUND/Projects/MP163/0220/INFO/LCMS_library_template.xlsx"
```
   
   
   
#5.colname of retention time ðŸ•µ
```{r eval=FALSE}
colname_rt <- "Library.rt.RF" # or "Library.rt.HILLIC"
```

    

   
#5.Parameters for getting chromatogram ðŸ•µ
```{r eval=FALSE} 
params <- list()
   
params$CentWave <- CentWaveParam( ppm = 20,
                                  peakwidth =  c(0.05,0.2)*60,
                                  snthresh = 2,
                                  noise = 1500,
                                  prefilter = c(3,1500),
                                  integrate = 2,
                                  mzdiff = -0.001,
                                  verboseColumns = TRUE,
                                  fitgauss = TRUE,
                                  extendLengthMSW = TRUE
   )
```

   
   



#6.Conducting 
```{r eval=FALSE}
if (grepl("ku_00007", path_files_mzML)) {
     
     source("")
     
} else {source(paste0(path_utils_prepro, "/XCMS_checkRT.R"))}
```

   
   
  




## Extraction of MS2-spectra
<font color = "red">If you skip the previous step, please make sure the retention time to be as correct as possible and fill in information related to the standards in the excel file as mentioned in the previous step</font>

The script `3b.Pipeline_extract_MS2_std.R` is available under the folder of `J:\CBMR\SUN-CBMR-Metabolomics\Workflow\Script\modules\MS2_preprocessing`




### Source paths on the server
```{r eval=FALSE}
source("H:/From_SUND/Scripts/utils/utils_MS2_set_up/set_up_paths.R")
```

 
 
 

### Provide polarity ðŸ•µ
```{r eval=FALSE}
polarity <- "NEG"
```
   
   
   
### Path of storing .mzML files without filenames ðŸ•µ
```{r eval=FALSE}
path_files_mzML <- "H:/From_SUND/Projects/MP163/0220/NEG/mzML_DA_NEG/mzML_openms_MS2_NEG"
```

  

### Path of storing outputs ðŸ•µ
```{r eval=FALSE}
path_outputs <- "H:/From_SUND/Projects/MP163/0220/outputs"
```

   

### Absolute path of template with essential information of standards ðŸ•µ
```{r eval=FALSE}
xlsx_std_info <- "H:/From_SUND/Projects/MP163/0220/outputs_NEG/metadata_for_MS2.xlsx"
```

  
   
### colname of retention time ðŸ•µ
```{r eval=FALSE}
colname_rt <- "rt_detected" # or "Library.rt.RF" # or "Library.rt.HILLIC" 
```


   
### Parameters for extracting MS2 spectra ðŸ•µ
#### Extraction: Threshold of rt and m/z for extraction ðŸ•µ
```{r eval=FALSE}
params <- list()
params$expandRt <- 5 #seconds
params$expandMz <- 0.01
```

   
   
#### How many maximal number of scans you would like to keep for further getting combined spectrum for each std ðŸ•µ
```{r eval=FALSE}
n_scans <- 6 # (5 CEs * 6/ 1CE*3)
```
  
   
   
#### Combining: Threshold of mz, proportion among all samples, type for combining, function for combining mz and intensity ðŸ•µ
```{r eval=FALSE}
#To get consensus spectra for each feature at each collision energy
params$tolerance <- 0.005
params$peaks <- "intersect"  #"union" #report all peaks from all input spectra 
params$minProp <- 0.7
params$intfun <- max
params$mzfun <- median
```



### Conducting 
```{r eval=FALSE}
if (grepl("ku_00007", path_files_mzML)) {
     
     source("")
     
} else {source(paste0(path_utils_prepro, "/extract_MS2_std.R"))}
```

   
   
  
   



